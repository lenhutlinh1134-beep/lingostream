<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>LingoStream - H·ªçc ti·∫øng Anh qua video & AI</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    /* ...gi·ªØ nguy√™n ph·∫ßn style nh∆∞ file g·ªëc... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: Arial, sans-serif; background: linear-gradient(to right, #f8f9ff, #f0f0ff); overflow: hidden; }
    header {
      height: 60px;
      background: linear-gradient(90deg,#6c5ce7 60%,#a29bfe 100%);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(108,92,231,0.08);
    }
    .main { display: flex; height: calc(100% - 60px); }
    .left { flex: 2; display: flex; flex-direction: column; align-items: center; padding: 10px; }
    .right { flex: 1; border-left: 2px solid #ccc; display: flex; flex-direction: column; padding: 10px; background: #ffffffaa; overflow-y: auto; }
    video {
      width: 100%;
      max-width: 540px;         /* 1080/2 = 540, ph√π h·ª£p v·ªõi khung web */
      height: auto;
      aspect-ratio: 4 / 5;      /* T·ª∑ l·ªá 4:5 cho video d·ªçc */
      max-height: 675px;        /* 1350/2 = 675 */
      border: 3px solid #6c5ce7;
      border-radius: 12px;
      object-fit: contain;
      background: #000;
      display: block;
      margin: 0 auto;
    }
    .subtitle-box { width: 100%; height: 30%; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 10px; padding: 10px; overflow-y: auto; }
    .subtitle-line { font-size: 18px; padding: 4px 8px; border-left: 4px solid transparent; margin-bottom: 4px; cursor: pointer; }
    .subtitle-line.active { background: #e0e7ff; font-weight: bold; border-left: 4px solid #6c5ce7; }
    .subtitle-line:hover {
  background: #f3f0ff;
  border-left: 4px solid #a29bfe;
  transition: background 0.2s, border-left 0.2s;
}
    .chat-box { flex: 1; display: flex; flex-direction: column; background: #f2f2ff; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
    .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 10px; }
    .chat-input { display: flex; }
    .chat-input input { flex: 1; padding: 8px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }
    .chat-input button { padding: 8px 12px; margin-left: 6px; border: none; border-radius: 6px; background-color: #6c5ce7; color: white; font-weight: bold; cursor: pointer; }
    .note-box { background: #fff3cd; padding: 10px; border-radius: 10px; margin-top: 10px; }
    .note-box ul { list-style: disc; padding-left: 20px; }
    .note-box button { margin-top: 10px; }
    .subtitle-select { margin: 10px; padding: 5px; font-size: 16px; }
    .left, .right {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(108,92,231,0.08);
      margin: 12px;
      padding: 18px;
    }
    button {
      background: linear-gradient(90deg,#6c5ce7,#a29bfe);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(108,92,231,0.08);
      transition: background 0.2s;
    }
    button:hover {
      background: linear-gradient(90deg,#a29bfe,#6c5ce7);
    }
    .subtitle-box {
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
  </style>
  <script>
    if (location.protocol === 'file:') {
      alert("‚ö†Ô∏è Chat GPT kh√¥ng ho·∫°t ƒë·ªông n·∫øu b·∫°n m·ªü file tr·ª±c ti·∫øp.\nH√£y d√πng VS Code + Live Server ho·∫∑c host web l√™n m·∫°ng!");
    }
  </script>
</head>
<body>
  <header>
    <img src="https://cdn-icons-png.flaticon.com/512/5968/5968267.png" alt="logo" style="height:36px;vertical-align:middle;margin-right:12px;">
    LingoStream - H·ªçc ti·∫øng Anh qua video & AI
  </header>
  <div class="main">
    <div class="left">
      <input type="file" id="videoInput" accept="video/*" />
      <select class="subtitle-select" id="subtitleSelect" onchange="changeEpisode(this.value)">
        <option value="1">T·∫≠p 1</option>
        <option value="2">T·∫≠p 2</option>
        <option value="3">T·∫≠p 3</option>
        <option value="4">T·∫≠p 4</option>
        <option value="5">T·∫≠p 5</option>
      </select>
      <video id="video" controls></video>
      <button onclick="repeatCurrentLine()" style="margin-top: 10px;">üîÅ L·∫∑p l·∫°i c√¢u ƒëang n√≥i</button>
      <button onclick="video.pause()" style="margin-top: 10px;">‚èπÔ∏è D·ª´ng video</button>
      <div class="subtitle-box" id="subtitles"></div>
    </div>
    <div class="right">
      <div class="chat-box">
        <div class="chat-messages" id="chatMessages">
          <div><strong>AI:</strong> Ch√†o b·∫°n! Nh·∫≠p ti·∫øng Anh v√†o chat box ƒë·ªÉ m√¨nh d·ªãch sang ti·∫øng Vi·ªát nh√© ü§ñ</div>
        </div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Nh·∫≠p c√¢u ti·∫øng Anh ƒë·ªÉ d·ªãch..." />
          <button onclick="sendMessage()">G·ª≠i</button>
        </div>
      </div>
      <div class="note-box">
        <h4>üìù T·ª´ v·ª±ng ƒë√£ l∆∞u</h4>
        <ul id="wordList"></ul>
        <button onclick="exportWordList()">üìÑ Xu·∫•t file Word</button>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById("video");
    const input = document.getElementById("videoInput");
    const subs = document.getElementById("subtitles");
    const wordList = document.getElementById("wordList");
    const episodeSelect = document.getElementById("subtitleSelect");

    let savedWords = [];
    let allSubtitles = [];
    let subtitles = [];
    let currentEpisode = 1;

    // Load ph·ª• ƒë·ªÅ th·∫≠t t·ª´ file JSON ƒë√£ t·ªïng h·ª£p
    fetch('all_subtitles_episodes_1_to_5.json')
      .then(res => res.json())
      .then(data => {
        allSubtitles = data;
        changeEpisode(currentEpisode);
      });

    function renderSubtitles() {
      subs.innerHTML = "";
      subtitles.forEach((line, i) => {
        const div = document.createElement("div");
        div.className = "subtitle-line";
        div.id = "sub-" + i;
        const safeEn = line.en.replace(/'/g, "\\'");
        div.innerHTML = `
          <div onclick="saveWord('${safeEn}')">${line.en}</div>
          <div style="color: gray; font-size: 16px;">${line.vi}</div>
          <button onclick="translateSubtitle('${safeEn}', ${i})">D·ªãch AI</button>
        `;
        div.onclick = () => {
          video.currentTime = line.start;
          video.play();
        };
        subs.appendChild(div);
      });
    }
    
    async function translateSubtitle(text, idx) {
      const div = document.getElementById("sub-" + idx);
      const btn = div.querySelector("button");
      btn.disabled = true;
      btn.textContent = "ƒêang d·ªãch...";
      try {
        const response = await fetch("http://localhost:4000/api/translate", { // S·ª≠a ƒë∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ message: text })
        });
        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || "(Kh√¥ng c√≥ ph·∫£n h·ªìi)";
        div.querySelector("div[style]").textContent = reply;
      } catch {
        div.querySelector("div[style]").textContent = "L·ªói d·ªãch AI";
      }
      btn.disabled = false;
      btn.textContent = "D·ªãch AI";
    }

    function changeEpisode(value) {
      currentEpisode = Number(value);
      subtitles = allSubtitles.filter(line => line.episode === currentEpisode);
      renderSubtitles();
    }

    function repeatCurrentLine(times = 1) {
      const current = video.currentTime;
      const currentLine = subtitles.find(line => current >= line.start && current <= line.end);
      if (currentLine) {
        let count = 0;
        video.currentTime = currentLine.start;
        video.play();
        video.onended = function() {
          count++;
          if (count < times) {
            video.currentTime = currentLine.start;
            video.play();
          } else {
            video.onended = null;
          }
        };
      }
    }

    input.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        video.src = url;
        video.load();
      }
    });

    video.addEventListener("timeupdate", () => {
      const current = video.currentTime;
      subtitles.forEach((line, i) => {
        const el = document.getElementById("sub-" + i);
        if (el) {
          if (current >= line.start && current <= line.end) {
            el.classList.add("active");
            // Auto scroll ƒë·∫øn d√≤ng ph·ª• ƒë·ªÅ hi·ªán t·∫°i
            el.scrollIntoView({ behavior: "smooth", block: "center" });
          } else {
            el.classList.remove("active");
          }
        }
      });
    });

    // üü¢ H√ÄM CHAT BOX D·ªäCH ANH-VI·ªÜT B·∫∞NG AI (GPT)
    async function sendMessage() {
      const input = document.getElementById("chatInput");
      const message = input.value.trim();
      if (!message) return;
      const chat = document.getElementById("chatMessages");
    
      const userMsg = document.createElement("div");
      userMsg.innerHTML = `<strong>B·∫°n:</strong> ${message}`;
      chat.appendChild(userMsg);
    
      const aiMsg = document.createElement("div");
      aiMsg.innerHTML = `<strong>AI:</strong> <em>ƒêang d·ªãch...</em>`;
      chat.appendChild(aiMsg);
      chat.scrollTop = chat.scrollHeight;
    
      try {
        const response = await fetch("http://localhost:4000/api/translate", { // S·ª≠a ƒë∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({ message })
        });
    
        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || "(Kh√¥ng c√≥ ph·∫£n h·ªìi)";
        aiMsg.innerHTML = `<strong>AI:</strong> ${reply}`;
      } catch (err) {
        aiMsg.innerHTML = `<strong>AI:</strong> L·ªói k·∫øt n·ªëi t·ªõi GPT üò•`;
      }
    
      input.value = "";
      chat.scrollTop = chat.scrollHeight;
    }

    function saveWord(word, meaning = "") {
      if (!savedWords.some(w => w.word === word)) {
        savedWords.push({ word, meaning });
        const li = document.createElement("li");
        li.textContent = meaning ? `${word} - ${meaning}` : word;
        wordList.appendChild(li);
      }
    }

    function exportWordList() {
      let content = "Danh s√°ch t·ª´ v·ª±ng ƒë√£ l∆∞u:\n\n" + savedWords.map(w => `- ${w.word}${w.meaning ? ' - ' + w.meaning : ''}`).join("\n");
      const blob = new Blob([content], { type: "application/msword" });
      saveAs(blob, "tu-vung.doc");
    }

    episodeSelect.addEventListener('change', function() {    // ...existing code...
      changeEpisode(this.value);
    });

  </script>
</body>
</html>
