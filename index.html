<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>LingoStream - H·ªçc ti·∫øng Anh qua video & AI</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { height: 100%; font-family: Arial, sans-serif; background: linear-gradient(to right, #f8f9ff, #f0f0ff); overflow: hidden; }
    header { height: 60px; background: #6c5ce7; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: bold; }
    .main { display: flex; height: calc(100% - 60px); }
    .left { flex: 2; display: flex; flex-direction: column; align-items: center; padding: 10px; }
    .right { flex: 1; border-left: 2px solid #ccc; display: flex; flex-direction: column; padding: 10px; background: #ffffffaa; overflow-y: auto; }
    video { width: 100%; height: 50%; border: 3px solid #6c5ce7; border-radius: 12px; object-fit: contain; }
    .subtitle-box { width: 100%; height: 30%; background: white; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-top: 10px; padding: 10px; overflow-y: auto; }
    .subtitle-line { font-size: 18px; padding: 4px 8px; border-left: 4px solid transparent; margin-bottom: 4px; cursor: pointer; }
    .subtitle-line.active { background: #e0e7ff; font-weight: bold; border-left: 4px solid #6c5ce7; }
    .chat-box { flex: 1; display: flex; flex-direction: column; background: #f2f2ff; border-radius: 10px; padding: 10px; margin-bottom: 10px; }
    .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 10px; }
    .chat-input { display: flex; }
    .chat-input input { flex: 1; padding: 8px; font-size: 16px; border-radius: 6px; border: 1px solid #ccc; }
    .chat-input button { padding: 8px 12px; margin-left: 6px; border: none; border-radius: 6px; background-color: #6c5ce7; color: white; font-weight: bold; cursor: pointer; }
    .note-box { background: #fff3cd; padding: 10px; border-radius: 10px; margin-top: 10px; }
    .note-box ul { list-style: disc; padding-left: 20px; }
    .note-box button { margin-top: 10px; }
    .subtitle-select { margin: 10px; padding: 5px; font-size: 16px; }
  </style>
  <script>
    // Hi·ªÉn th·ªã c·∫£nh b√°o n·∫øu ch·∫°y file tr·ª±c ti·∫øp
    if (location.protocol === 'file:') {
      alert("‚ö†Ô∏è Chat GPT kh√¥ng ho·∫°t ƒë·ªông n·∫øu b·∫°n m·ªü file tr·ª±c ti·∫øp.\nH√£y d√πng VS Code + Live Server ho·∫∑c host web l√™n m·∫°ng!");
    }
  </script>
</head>
<body>
  <header>üé¨ LingoStream - H·ªçc ti·∫øng Anh qua video & AI</header>
  <div class="main">
    <div class="left">
      <input type="file" id="videoInput" accept="video/*" />
      <select class="subtitle-select" id="subtitleSelect" onchange="changeEpisode(this.value)">
        <option value="episode_1">T·∫≠p 1</option>
        <option value="episode_2">T·∫≠p 2</option>
        <option value="episode_3">T·∫≠p 3</option>
        <option value="episode_4">T·∫≠p 4</option>
        <option value="episode_5">T·∫≠p 5</option>
      </select>
      <video id="video" controls></video>
      <button onclick="repeatCurrentLine()" style="margin-top: 10px;">üîÅ L·∫∑p l·∫°i c√¢u ƒëang n√≥i</button>
      <div class="subtitle-box" id="subtitles"></div>
    </div>
    <div class="right">
      <div class="chat-box">
        <div class="chat-messages" id="chatMessages">
          <div><strong>AI:</strong> Ch√†o b·∫°n! Nh·∫≠p ti·∫øng Anh v√†o chat box ƒë·ªÉ m√¨nh d·ªãch sang ti·∫øng Vi·ªát nh√© ü§ñ</div>
        </div>
        <div class="chat-input">
          <input type="text" id="chatInput" placeholder="Nh·∫≠p c√¢u ti·∫øng Anh ƒë·ªÉ d·ªãch..." />
          <button onclick="sendMessage()">G·ª≠i</button>
        </div>
      </div>
      <div class="note-box">
        <h4>üìù T·ª´ v·ª±ng ƒë√£ l∆∞u</h4>
        <ul id="wordList"></ul>
        <button onclick="exportWordList()">üìÑ Xu·∫•t file Word</button>
      </div>
    </div>
  </div>

  <script>
    const video = document.getElementById("video");
    const input = document.getElementById("videoInput");
    const subs = document.getElementById("subtitles");
    const wordList = document.getElementById("wordList");

    let savedWords = [];
    let subtitles = [];

    // D·ªØ li·ªáu ph·ª• ƒë·ªÅ m·∫´u, b·∫°n c√≥ th·ªÉ thay b·∫±ng ph·ª• ƒë·ªÅ th·∫≠t (JSON)
    const subtitleSets = {
      "episode_1": [],
      "episode_2": [],
      "episode_3": [],
      "episode_4": [],
      "episode_5": []
    };

    function renderSubtitles() {
      subs.innerHTML = "";
      subtitles.forEach((line, i) => {
        const div = document.createElement("div");
        div.className = "subtitle-line";
        div.id = "sub-" + i;
        const safeEn = line.en.replace(/'/g, "\\'");
        div.innerHTML = `<div onclick="saveWord('${safeEn}')">${line.en}</div><div style="color: gray; font-size: 16px;">${line.vi}</div>`;
        div.onclick = () => {
          video.currentTime = line.start;
          video.play();
        };
        subs.appendChild(div);
      });
    }

    function changeEpisode(value) {
      subtitles = subtitleSets[value] || [];
      renderSubtitles();
    }

    function repeatCurrentLine() {
      const current = video.currentTime;
      const currentLine = subtitles.find(line => current >= line.start && current <= line.end);
      if (currentLine) {
        video.currentTime = currentLine.start;
        video.play();
      }
    }

    input.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        video.src = url;
        video.load();
      }
    });

    video.addEventListener("timeupdate", () => {
      const current = video.currentTime;
      subtitles.forEach((line, i) => {
        const el = document.getElementById("sub-" + i);
        if (el) {
          if (current >= line.start && current <= line.end) {
            el.classList.add("active");
          } else {
            el.classList.remove("active");
          }
        }
      });
    });

    // üü¢ H√ÄM CHAT BOX D·ªäCH ANH-VI·ªÜT B·∫∞NG AI (GPT)
    async function sendMessage() {
      const input = document.getElementById("chatInput");
      const message = input.value.trim();
      if (!message) return;
      const chat = document.getElementById("chatMessages");

      const userMsg = document.createElement("div");
      userMsg.innerHTML = `<strong>B·∫°n:</strong> ${message}`;
      chat.appendChild(userMsg);

      const aiMsg = document.createElement("div");
      aiMsg.innerHTML = `<strong>AI:</strong> <em>ƒêang d·ªãch...</em>`;
      chat.appendChild(aiMsg);
      chat.scrollTop = chat.scrollHeight;

      try {
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "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" // 
          },
          body: JSON.stringify({
            model: "gpt-3.5-turbo",
            messages: [
              { role: "system", content: "B·∫°n l√† m·ªôt tr·ª£ l√Ω d·ªãch thu·∫≠t ti·∫øng Anh sang ti·∫øng Vi·ªát, ch·ªâ tr·∫£ v·ªÅ b·∫£n d·ªãch ti·∫øng Vi·ªát kh√¥ng gi·∫£i th√≠ch th√™m." },
              { role: "user", content: `D·ªãch c√¢u n√†y sang ti·∫øng Vi·ªát: ${message}` }
            ]
          })
        });

        const data = await response.json();
        const reply = data.choices?.[0]?.message?.content || "(Kh√¥ng c√≥ ph·∫£n h·ªìi)";
        aiMsg.innerHTML = `<strong>AI:</strong> ${reply}`;
      } catch (err) {
        aiMsg.innerHTML = `<strong>AI:</strong> L·ªói k·∫øt n·ªëi t·ªõi GPT üò•`;
      }

      input.value = "";
      chat.scrollTop = chat.scrollHeight;
    }

    function saveWord(word) {
      if (!savedWords.includes(word)) {
        savedWords.push(word);
        const li = document.createElement("li");
        li.textContent = word;
        wordList.appendChild(li);
      }
    }

    function exportWordList() {
      let content = "Danh s√°ch t·ª´ v·ª±ng ƒë√£ l∆∞u:\\n\\n" + savedWords.map(w => `- ${w}`).join("\\n");
      const blob = new Blob([content], { type: "application/msword" });
      saveAs(blob, "tu-vung.doc");
    }

    changeEpisode("episode_1");
  </script>
</body>
</html>
